<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Impact Index - Your Site</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <style>
        /* ... (previous styles remain the same) ... */
    </style>
</head>
<body>
    <header>
        <h1><a href="index.html">Your Site</a></h1>
    </header>

    <main>
        <div class="solar-card">
            <h2>Solar Impact Index</h2>
            <div id="result">
                <p class="status loading">Calculating solar impact...</p>
            </div>
            <div id="chart" class="chart-container">
                <!-- Chart will be rendered here -->
            </div>
            <div class="legend">
                <h3>Understanding the Impact Index</h3>
                <p>Comparing today's solar activity with the past 7 days:</p>
                <p class="legend-item">• X-class flares (×100): Major events with global impacts</p>
                <p class="legend-item">• M-class flares (×10): Strong events</p>
                <p class="legend-item">• C-class flares (×1): Minor events</p>
                <p class="legend-item">• B-class flares (×0.1): Background activity</p>
            </div>
            <button onclick="analyzeSolarActivity()" class="check-button">
                Check Again
            </button>
        </div>
    </main>

    <footer>
        <p>Data provided by NASA's DONKI API • © 2025</p>
    </footer>

    <script>
        // Utility functions
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function fetchWithRetry(url, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        return data;
                    }
                    if (response.status === 429) { // Rate limit
                        console.log('Rate limit hit, waiting...');
                        await sleep(2000); // Wait 2 seconds before retry
                        continue;
                    }
                    throw new Error(`HTTP ${response.status}`);
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) throw error;
                    await sleep(1000); // Wait 1 second between retries
                }
            }
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function getDateXDaysAgo(days) {
            const date = new Date();
            date.setDate(date.getDate() - days);
            return date;
        }

        // Simplified impact score calculation
        function calculateImpactScore(flare) {
            const classType = flare.classType?.charAt(0) || 'C';
            const magnitude = parseFloat(flare.classType?.slice(1)) || 1;
            
            const scores = {
                'X': 100,
                'M': 10,
                'C': 1,
                'B': 0.1
            };
            
            return (scores[classType] || 1) * magnitude;
        }

        function renderChart(data) {
            const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } = Recharts;
            
            ReactDOM.render(
                React.createElement(ResponsiveContainer, { width: '100%', height: 300 },
                    React.createElement(BarChart, { 
                        data: data,
                        margin: { top: 20, right: 30, left: 20, bottom: 5 }
                    },
                        React.createElement(XAxis, { 
                            dataKey: "date",
                            tickFormatter: (value) => value.split('-')[2] // Show only day
                        }),
                        React.createElement(YAxis),
                        React.createElement(Tooltip),
                        React.createElement(Bar, {
                            dataKey: "impact",
                            fill: "#0066cc",
                            name: "Solar Impact"
                        })
                    )
                ),
                document.getElementById('chart')
            );
        }

        async function analyzeSolarActivity() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="status loading">Calculating solar impact...</p>';

            try {
                // Reduce the date range to 7 days to avoid rate limits
                const today = new Date();
                const sevenDaysAgo = getDateXDaysAgo(7);
                
                console.log('Fetching data from', formatDate(sevenDaysAgo), 'to', formatDate(today));

                const data = await fetchWithRetry(
                    `https://api.nasa.gov/DONKI/FLR?startDate=${formatDate(sevenDaysAgo)}&endDate=${formatDate(today)}&api_key=DEMO_KEY`
                );

                console.log('Received data:', data);

                // Initialize daily impact scores
                const dailyImpact = {};
                for (let i = 7; i >= 0; i--) {
                    const date = getDateXDaysAgo(i);
                    dailyImpact[formatDate(date)] = 0;
                }

                // Process flare data
                if (Array.isArray(data)) {
                    data.forEach(flare => {
                        const day = formatDate(new Date(flare.beginTime));
                        if (dailyImpact.hasOwnProperty(day)) {
                            dailyImpact[day] += calculateImpactScore(flare);
                        }
                    });
                }

                // Prepare chart data
                const chartData = Object.entries(dailyImpact).map(([date, impact]) => ({
                    date,
                    impact,
                    isToday: date === formatDate(today)
                }));

                // Calculate metrics
                const todayImpact = dailyImpact[formatDate(today)];
                const avgImpact = Object.values(dailyImpact).reduce((a, b) => a + b, 0) / 7;
                const ratio = avgImpact ? todayImpact / avgImpact : 0;

                // Generate status message
                let status, details;
                if (todayImpact === 0) {
                    status = '<span class="low">QUIET SUN</span>';
                    details = 'No significant solar activity detected today.';
                } else if (ratio > 3) {
                    status = '<span class="extreme">MAJOR ACTIVITY</span>';
                    details = `Impact score: ${todayImpact.toFixed(1)} (${ratio.toFixed(1)}x weekly average)`;
                } else if (ratio > 1.5) {
                    status = '<span class="high">ENHANCED ACTIVITY</span>';
                    details = `Impact score: ${todayImpact.toFixed(1)} (${ratio.toFixed(1)}x weekly average)`;
                } else {
                    status = '<span class="normal">NORMAL ACTIVITY</span>';
                    details = `Impact score: ${todayImpact.toFixed(1)} (near average)`;
                }

                resultDiv.innerHTML = `
                    <p class="status">${status}</p>
                    <p class="details">${details}</p>
                `;

                renderChart(chartData);

            } catch (error) {
                console.error('Detailed error:', error);
                resultDiv.innerHTML = `
                    <p class="status">Unable to fetch solar data</p>
                    <p>We'll try again in a moment. If this persists, the API may be rate limited.</p>
                `;
                
                // Auto-retry after 5 seconds
                setTimeout(analyzeSolarActivity, 5000);
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', analyzeSolarActivity);
    </script>
</body>
</html>
